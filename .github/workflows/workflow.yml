name: Deploy Native Image to Server

on:
  push:
    branches: [ "master" ]  # 核心修改：这里必须是 master，与你的分支名一致
  workflow_dispatch:        # 核心修改：保留这个，让你能手动点按钮

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取代码
      - uses: actions/checkout@v3

      # 2. 设置 JDK 17 和 GraalVM 环境
      - uses: graalvm/setup-graalvm@v1
        with:
          java-version: '17'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          native-image-job-reports: 'true'

      # 3. 登录 Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4. 云端运行 Maven 构建并推送
      - name: Build Native Image and Push
        run: |
          # 这里的 -D... 是为了覆盖 pom.xml 里的配置，强制加上 Docker Hub 用户名前缀
          ./mvnw spring-boot:build-image -Dspring-boot.build-image.imageName=${{ secrets.DOCKER_USERNAME }}/imserver:latest --no-transfer-progress
          docker push ${{ secrets.DOCKER_USERNAME }}/imserver:latest

      # 5. 远程连接你的服务器，更新运行
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: root
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # 停止旧容器 (|| true 代表如果容器不存在也不报错，继续执行)
            docker stop my-app || true
            docker rm my-app || true
            
            # 拉取刚才推送到 Docker Hub 的新镜像
            docker pull ${{ secrets.DOCKER_USERNAME }}/imserver:latest
            
            # 启动新容器
            docker run -d -p 8080:8080 --name my-app ${{ secrets.DOCKER_USERNAME }}/imserver:latest