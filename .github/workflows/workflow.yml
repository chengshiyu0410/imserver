name: Deploy Native Image to Server

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取代码
      - uses: actions/checkout@v3

      # 2. 设置 JDK 21 和 GraalVM 环境
      - uses: graalvm/setup-graalvm@v1
        with:
          java-version: '21'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          native-image-job-reports: 'true'

      # 3. 登录 Docker Hub (虽然不用推流，但登录一下是个好习惯)
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4. 构建并导出为文件 (最简版：完全信任 pom.xml)
      - name: Build and Export
        run: |
          chmod +x mvnw
          
          # 1. 构建镜像
          # 注意：这里不加任何参数，它会自动读取 pom.xml 里的 <BP_NATIVE_IMAGE>true</BP_NATIVE_IMAGE>
          ./mvnw spring-boot:build-image --no-transfer-progress

          # 2. 改名 (对应 pom.xml 里的 <name>imserver:latest</name>)
          docker tag imserver:latest chengshiyu1/imserver:latest

          # 3. 保存为 tar 文件
          docker save -o imserver.tar chengshiyu1/imserver:latest

      # 5. 把文件直接传给服务器 (SCP 模式)
      - name: Copy file to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: root
          password: ${{ secrets.SERVER_PASSWORD }}
          source: "imserver.tar"
          target: "/root"

      # 6. 服务器解压并启动
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: root
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # 1. 停止并删除旧容器
            docker stop imserver || true
            docker rm imserver || true
            
            # 2. 加载新镜像
            docker load -i /root/imserver.tar
            
            # 3. 启动容器
            # 注意：去掉了日志挂载，先用 docker logs 看，避免权限问题
            docker run -d -p 8080:8080 --name imserver chengshiyu1/imserver:latest
            
            # 4. 清理垃圾
#            rm -f /root/imserver.tar